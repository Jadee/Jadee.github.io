---
title: 计算广告-pacing优化技术
date: 2019-03-02
categories: 计算广告
tags:
- 计算广告
- Pacing
---

# 背景
广告系统是用户、广告主、平台三方博弈的生态。用户希望通过搜索词（或者浏览）找到符合自己意图得信息或商品，广告主则希望通过投放策略的优化找到更精准的用户实现投放效果的优化，平台是连接消费者和广告主的桥梁，帮助广告主匹配到合适的用户实现投放诉求，实现流量变现效率最大化。

<!-- more -->

广告平台核心包含两个子平台，demand 端和 supply 端，supply 端面向平台，实现广告的在线分配，目标是优化分配效率，以在保证相关性用户体验下实现流量变现效率最大化为目标；而 demand 端优化是面向广告主，通过提供各种工具帮助广告主优化投放效率和效果。

影响广告主投放效果的因素有很多，其中预算（budget）是广告主控制花费，调节效果与花费的重要抓手。直通车的账户结构是，一个账户（cust）下有多个计划（campaign），每个计划下有多个推广单元（adgroup），预算是设置在计划维度，代表该计划当天（24h）允许的花费上限，在达到预算日限额后，整个广告计划将下线。
预算花费策略而言，在广告主手动控制下，只能设置一定的价格，按照时间顺序参与所有流量的竞争，拿到获胜的流量，而无法实现优中选优的有利策略，实现预算花费效率最大化。同时对于预算不足的计划，预算花费速度不合理将带来如下问题：
1. 预算在每天初期消耗殆尽，无法参与后期竞价，每天后半天的优质流量无法触达
2. 人群覆盖不全，对TA人群分析和客户拉新不利
3. 从成交额角度看无法实现当前限定预算下效果最优

预算花费控制优化是 demand 端帮助广告主优化投放效果的重要手段，我们称之为 pacing，其核心目标是解决预算不足撞线客户的预算花费控制问题，在限定预算约束条件下，帮助广告主全局优选最优质的流量，实现campaign当前设置下成交额最大化，同时提升客户在线时长，提升受众触达和人群覆盖，提升店铺基于人群的效果优化效率，另外通过 pacing 全局控制对平台来说，可以平滑全天的竞争程度，长期来看有利于生态的健康发展。

# 意义
pacing 的意义显而易见：

1. 提升客户在线时长，扩大受众面
2. 竞争程度相对均衡，长期来看利于生态健康发展
3. 有选择性的投放，提升客户的效果（成交额）

从平台角度来看，在广告的投放过程中，随着时间推移撞线的campaign的量越来越多，竞价深度逐渐减少，rpm（折线图）持续走低

# 技术方案
pacing 的常用手段为 throttling 和 biding，throttling 控制每次 pv 参不参与竞价，biding 控制每次 pv 的出价。

## throttling 方案
throttling 思路简单，pacing 帮助预算不足的 campaign 选择一部分差的 pv 放弃竞价，使得剩下的优质 pv 刚好花完预算。

### 建模
站在 campaign 视角，选择最好的 pv，建模方式如下：

$$ max \sum_{i = 1}^n p_i * x_i $$

$$ s.t. \sum_{i = 1}^n c_i * x_i \leq B $$

$$ \quad \quad x_i \in \{0, 1\}, \quad 1 \leq i \leq n  $$

$B$：campaign 的预算<br>
$c_i$：campaign在 pv i 上的ecpm <br>
$p_i$：campaign 在 pv i 上的收益，即预估成交额<br>
$x_i$：待求变量，campaign 是否选择 pv i，$x_i \in \{0, 1\}$

原问题可以归类到 0-1 背包问题，是典型的 NP-hard 问题，因此这里我们采用贪心近似算法，流程如下：

1. pv二元组按$roi_i = \frac{p_i}{c_i}$降序排列，即$(c_{k1}, p_{k1}), (c_{k2}, p_{k2}),...,(c_{kn}, p_{kn})$，其中$\frac{p_i}{c_i} \geq \frac{p_j}{c_j}, \forall i \ge j$

2. 选择 top m 的 pv，尽量使得预算花完，即 $m = maxarg_j \sum_{i = 1}^j c_{k_i} \leq B $

最终

$$ x_i = \left\{
\begin{array}{rcl}
1       &      & {if i \in \{k_1, k_2, ..., k_m\} }\\
0       &      & {otherwise}
\end{array} \right. 
\quad \forall i \in \{1, 2, ..., n\}
$$

贪心算法得到的近似解离最优解离多远呢？ 

推论：如果每个物品重量都小于等于背包容量的$\frac{1}{n}$，那么 0-1 背包问题贪心解为$\rho-$近似解，$\rho = \frac{n - 1}{n}$。

直观理解：贪心算法选完最后一个物品后剩余的背包空间不足以选择下一个物品，造成了空间浪费，真正的最优解有可能会将贪心算法选择的最后几个物品替换掉来充分利用背包空间。然而，如果物品的重量都很小，背包的容量非常大，那么，背包的空间利用率就非常高，就算最后一个物品不要也不会造成太大的收益损失。回到现实场景，一个广告计划 campaign 的预算最低为 30 元，假如平均 cpc 为 1 元，那么平均获得点击数为 30，又假如 ctr 为 0.1，获得的 pv 量为 300 左右，平均一个 pv 的期望消耗为 0.1 = 30 / 300，假如 pv 的最高期望消耗为 0.3（平均值的 3 倍），那么所有的 pv 期望消耗小于等于 $B / 100$，根据推论得知，$\rho = 0.99$，这在可接受的范围内。

实际应用中，求解$x_i$是不现实的，因为$x_i$对应的是一个 “精确” 的 pv，言下之意就是求解$x_i$需要知道未来的 pv 是哪些，因此需要用其他方式来描述$x_i$，根据算法特点，我们可以用 roi 阈值来区分选择的 pv，即：


$$ x_i = \left\{
\begin{array}{rcl}
1       &      & {if \frac{p_i}{c_i} \geq \theta }\\
0       &      & {otherwise}
\end{array} \right. 
\quad \forall i \in \{1, 2, ..., n\}
$$

其中

$$ \theta = \frac{p_{k_m}}{c_{k_m}} $$

$p_i$和$c_i$可以实时拿到，所以我们只需要额外知道阈值$\theta$就能决定是否参与竞价。另外，阈值有一个特点，就是它只和贪心算法选择的最后一个 pv 的 roi 有关，和前面的 pv 以及后面的 pv 都无关，因此，阈值不会因为实际 pv 分布的波动而太敏感。

为了方便进一步讨论，阈值的另一种表述方式如下：

$$ \theta_t = G(S[t, 24], B_t) $$

$ S\[t, 24\] $：当前 t 时刻到 24 点全速投放的 pv 二元组$(c, p)$集合

$ B_t $：t 时刻剩余预算

$ G(S, B) $：pv 二元组集合为 S，预算为 B 情况下使用贪心算法计算得到的 roi 阈值

### 实现

#### 预算$B_t$

campaign 的剩余预算可以很容易拿到，假如当前时间为 t，campaign 设置的预算为 $B'$，累计消耗为$C\[0, t\]$，那么 campaign 的剩余预算为：

$$ B_t = B - C[0, t] $$

#### 候选pv信息 $S\[t, 24\]$

$S\[t, 24\]$ 里的 pv 并没有实际发生，如果要精确预估 $S\[t, 24\]$ 里所有 pv 是不可能的。但我们的初衷仅仅是为了计算阈值，如果阈值和真实值差不多，就算得不到精确的 $S\[t, 24\]$ 也能接受 这里我们假设连续两天 $(c, p)$ 分布一样，但 pv 量存在波动，波动量用 $\alpha_t$表示，则：

$$ |S[t, 24]| = \alpha_t * S[t, 24] $$

于是我们得到新的阈值计算方法

$$ \tilde{\theta} = G(S[t, 24], B_t)$$ 

$S_{-1}\[t, 24\]$ : 前一天 t 时刻到 24 点全速投放的 pv 二元组集合 

关于 $\alpha_t$ 的预估，可以简单通过统计大盘波动得到。

#### $S_{-1}\[t, 24\]$ 计算

$S_{-1}\[t, 24\]$ 面临的问题主要有两个：<br> 
1. 全速投放的候选 pv 意味着 campaign 没有下线、没有任何 pacing 过滤机制获得的所有展现 <br> 
2. campaign 之间在选择 pv 上会有相互影响 

这里我们使用了影子系统 + 模拟系统来解决这个问题 影子系统：主要解决的是 campaign 下线后候选 pv 未知的问题，实际上，影子系统专门接受生产复制过来的流量（1%）。和生产的区别在于所有广告不下线。<br>
* 模拟系统：主要解决的是无 pacing 过滤机制，以及 campaign 相互影响的问题。<br>
* 模拟系统主要做的事情是收集影子系统产生的日志（包含不下线广告），离线做 ranking 模拟，以确定 campaign 的候选 pv。

影子系统逻辑比较简单就不细说了，接下来重点介绍模拟系统，模拟系统的主要逻辑为模拟每个 campaign 根据自己的预算从各自的候选 pv 中选择最优的 pv，通过迭代最终达到稳定的状态。详细算法如下：

$N_c$: campaign 总数量 <br>
$N_q$: pv 总数量 <br>
$q_{ij}$: campaign i 对应 pv j 的二元组 $(c_{ij}, p_{ij})$，$1 \leq i \leq N_c，1 \leq j \leq N_q$  <br>
$\theta_i$：campaign i 的 roi 阈值，$1 \leq i \leq N_c$

算法流程如下：

1. 初始化$\theta_i = 0，\forall 1 \leq i \leq N_c$ 

2. 并行模拟所有 pv，模拟前对每个 campaign i 使用各自的阈值 $\theta_i$ 过滤，模拟时计算 ecpm 和 roi，得到新的 $q$

3. 每个 campaign i 根据 $q_{i1}, q_{i2}, q_{i3}, ...，q_{in}$ 以及预算通过贪心算法得到新的阈值 $\theta_i$

4. 如果所有 campaign 的选择变化大于一定量，跳回步骤 2 

5. 所有 $c_{ij}$ 非 0 的 $q_{ij}$即为 campaign 的候选 pv 

实际迭代过程中，算法基本是收敛的，理论上收敛性这里暂不给证明

#### 整体流程

整体流程用一张大图来概括：

![avatar](/images/计算广告/ad-14.jpg)

实际投放过程中，pacing 模块通过 roi 阈值实时决定每个 ad（开启流量平滑的 campaign）是否参与竞价 在线更新模块负责每 10 分钟计算并更新一次 roi 阈值，其中会用到结算拿到的实时消耗和预算以及离线算好的候选 pv 离线系每天统根据影子系统记录的日志做模拟回放，得到每个 campaign 的候选 pv。

## biding 方案
