---
title: OCPC智能调价技术
date: 2019-03-01
categories: 计算广告
tags:
- 计算广告
- 机制设计
---

# 背景
出于对广告主结构、平台特点及变现能力等多方面的考虑，计算广告一般采用CPC（cost per click)计费模式，即按照点击计费的模式。传统CPC模式中广告主对单次点击出固定的价格，然而不同质量的流量上产生的点击价值是不同的，对于广告主而言，更好的出价方式是让出价与点击的价值更加匹配。

一种直观的想法是根据每条流量的预估转化率动态调整出价，即出价bid是关于预估转化率pcvr的函数:

  $$ bid^* = f(pcvr, base_{advertiser})$$
        
其中$base_{advertiser}$表示出价的基准是站在广告主的视角对其所有参竞流量进行区分，对高转化率的流量提高出价，对低转化率的流量降低出价。这样的做法可以帮助广告主提高其出价与流量价值的匹配性，提高流量分配效率，提升广告主的ROI。由于是站在单广告主角度进行思考的，这种方式的调控对于优化广告主自身利益有较好的效果，但对于优化流量大盘没有直接的保证，由此，引出了另一种站在流量大盘角度进行优化的方法。

作为广告平台方以及流量平台方，平台在提升收入的同时也需要做好用户体验，提升GMV。为了提升平台的GMV，一种做法是直接修改排序规则。传统的排序规则是按照bidscore * bid进行排序，当bidscore=pctr时，其目标是最大化RPM（ecpm排序规则），在某种情形下，我们可以将bidscore设为 a * pctr + b * pctr * pcvr的形式以提高大盘的GMV，但这种做法无法保障平台的收入RPM和广告主的利益。为了保证平台的收益，我们保持ecpm的排序规则不变，站在单流量的角度上，让高转化率的广告通过提升其报价的形式来提升其竞得该流量的能力，实现RPM与GMV的双赢，即：        

  $$ bid^* = g(pcvr, base_{traffic}) $$

结合广告主视角与平台视角，我们认为一个广告最后的出价应为：

  $$ bid^* = \alpha * f(pcvr, base_{advertiser}) + (1 - \alpha) * g(pcvr, base_{traffic}) $$
        
其中alpha取值越大越有利于广告主，取值越小越有利于平台。然而很难对每个广告主都找到合适的alpha，使得在保证所有广告主都能受益的前提下来达到大盘有较大提升。为了解决这个问题，我们将影响广告主收益的调价函数$f(pcvr, base_{advertiser})$作为约束，将着眼于平台收益的调价函数$g(pcvr, base_{traffic})$作为目标，对pv粒度上的广告主出价进行智能调整，最终形成ocpc技术。基于具体的业务场景和问题，我们提出的ocpc技术有以下三个核心点：

  * 对广告主实现更细粒度的出价，达到价与质的统一，从而提升其收益ROI。<br>
  * 对平台实现广告排序的调控，使得质量好的广告更容易展现，提升大盘GMV。<br>
  * 在保证广告主ROI及大盘GMV提升的前提下最大化RPM，实现平台收益的提升。

# 算法细节

本节主要介绍OCPC的算法细节，考虑到广告主利益、平台利益多方面因素，OCPC整体流程分为以下两步：

  1. 将提升广告主的ROI作为其调价的约束条件。<br>
  2. 在满足ROI约束的情况下，以优化大盘GMV为排序目标，动态调整每个广告主的出价，实现广告主生态与流量大盘的综合优化。
  
下面我们对两个步骤进行具体的介绍。

## ROI约束

ROI作为广告主的核心诉求是OCPC需要考虑的第一个问题，那么如何通过更精细的出价调整来实现广告主的ROI的提升呢？

对于一个CPC广告单元，其ROI为它的收益与投入的比值，其收益为总点击数乘以平均转化率再乘以商品价格，其投入为总点击数乘以单次点击的出价。

  $$ roi_a = \frac{v_a * \sum_u n_u * p(c|u, a)}{b_a * \sum_u n_u} = \frac{E[p(c|u, a)] * v_a}{b_a} $$
  
其中\\(u\\)代表一个用户user，\\(a\\)代表一个广告ad，\\(b_a\\)为单次点击上的扣费，\\(n_u\\)为一个用户$$u$$的点击数，\\(p\(c\|u, a\)\\)为此次点击上购买的概率（转化率），\\(v_a\\)为商品的售卖价。

商品的价格对同一个广告而言一般为一个定值，所以关系着ROI的两个重要因素就是转化率\\(p\(c\|u, a\)\\)和出价\\(b_a\\)，要实现价与质的统一，转化率\\(p\(c\|u, a\)\\)与出价\\(b_a\\)的比值应该为定值，即：

  $$ \frac{p(c|u, a)}{b_{a}^*} = \frac{roi_a}{v_a} = \frac{E[p(c|u, a)]}{b_a} $$
        
要保证一个广告单元的ROI有所提升或者不降，广告主对每条流量的出价应满足如下条件：

  $$ \frac{p(c|u, a)}{b_{a}^*} \geq \frac{roi_a}{v_a} = \frac{E[p(c|u, a)]}{b_a} $$

即：

  $$ \frac{b_{a}^*}{b_{a}} \leq \frac{p(c|u, a)}{E[p(c|u, a)]} $$
        
其中\\(b_a\\)为该广告的原始出价，\\(b_{a}^*\\)为OCPC调价后的出价，\\(p\(c\|u, a\)\\)为当前流量上的转化率，\\(E_{u}[p\(c\|u, a\)]\\)为该广告的平均转化率。对于\\(p\(c\|u, a\)\\)，我们使用一个混合逻辑回归（mlr）模型进行预估，而对于\\(E_{u}[p\(c\|u, a\)]\\)我们采用过去几天的统计平均值。

考虑到广告主既希望提升ROI又希望同时拿到更多流量的诉求，我们定义最后的调价约束满足以下两点：

  * 对预估转化率高的流量，上调出价以提高对高转化流量的获取能力，同时调价满足约束\\(\frac{b_{a}^*}{b_{a}} \leq \frac{p(c\|u, a)}{E[p(c\|u, a)]}\\)<br>
  * 对预估转化率低的流量，下调出价以降低在低转化流量上的花费。
  
即在OCPC中我们将广告主的调价范围定义在如下图的阴影部分:

  ![avatar](/images/计算广告/ad-13.png)
  
出于对风险的考虑，我们不希望出价被调整得过高或者过低，所以加入了\\(r_a = 0.4\\)作为调价范围的约束。

综上，调价的上下界为：

**下界**

  $$ l(b_{a}^*) = b_a * (1 - r_a), when  \frac{p(c|u, a)}{E_{u}[p(c|u, a)]} \le 1 $$
  
  $$ l(b_{a}^*) = b_a, when  \frac{p(c|u, a)}{E_{u}[p(c|u, a)]} \geq 1 $$

**上界**

  $$ u(b_{a}^*) = b_a, when  \frac{p(c|u, a)}{E_{u}[p(c|u, a)]} \le 1 $$
  
  $$ u(b_{a}^*) = b_a * min(1 + r_a, \frac{p(c|u, a)}{E_{u}[p(c|u, a)]}), when  \frac{p(c|u, a)}{E_{u}[p(c|u, a)]} \geq 1 $$     
        
## 调价排序

有了前文的调价约束，OCPC实现了对广告主利益的优化，此外，我们还需要考虑平台的利益与诉求。<br>
不同于通过修改排序分调控排序的方式，OCPC依然保持ecpm=ctr*bid的排序规则，通过修改出价来改变最后的排序，从而在保证rpm收益的同时实现对大盘GMV的调控。

OCPC调价排序的实质是：
在调价约束范围内对所有Ｎ条广告进行调价，使得在ecpm=ctr*bid的排序规则下展现的广告能最大化平台的诉求目标$f(k, b_k)$，即：

  $$ max_{b_1^*, \quad b_2^*, \quad  ...  &nbsp; b_n^*} f(k, b_k^*) $$
  
  $$ s.t. \quad  k = argmax_i pctr_i * b_i^* $$
        
  $$ \quad \quad l(b_i^*) \leq b_i^* \leq u(b_i^*) $$
       
平台的诉求目标函数的形式$f(k, b_k^*)$可以有很多种，如:

  $$ f_1(k, b_k^*) = pctr_k * pcvr_k * v_k $$
        
  $$ f_2(k, b_k^*) = pctr_k * pcvr_k * v_k + \alpha * pctr_k * b_k^* $$

其中$f_1(\cdot)$表示以提升平台GMV为目标, $f_2(\cdot)$表示以提升平台GMV和收入为目标.

在OCPC中，我们使用如下目标函数：

  $$ f(k, b_k^*) = pctr_k * b_k * (1 + \sigma(\frac{pcvr_k * v_k * ||A||}{\sum_{i \in A}pcvr_i * v_i}, w) * r_a) $$
        
其中$w = 6$ and $r_a = 0.4$

此目标函数本质上是将GMV * bid作为目标，即一方面我们希望能够提升平台的GMV，一方面我们保留广告主出价对流量的撬动能力。<br>
这里出于平滑的考虑，使用了定义域在$[0,+inf)$，值域在$[-1,1)$的非线性函数$y = \sigma(x, w) = \frac{x^w - 1}{x^w + 1}$，y随着x单调递增，且ｙ关于$log_x$对称，而$r_a = 0.4$是基于调价界限为0.4的限制。

有了以上定义，我们可以通过如下的方法进行求解:

为了让目标函数$f$最大的广告$ad_k$尽量靠前，该算法通过更新其他广告$ad_i$的出价上界$u(b_i^*)$，使其ecpm排序分数的上界$u(s_i)$不超过此广告$ad_k$的ecpm排序分数上界$u(s_k)$。

通常而言一次PV请求需要展现m条广告，因此这里进行多次循环，每次循环按照$f(\cdot)$排序选出最靠前的广告，检查其ecpm排序分数的上界$u(s_k)$是否大于后面其他广告的ecpm排序分下数的界$l(s_i)$，如果满足该条件，就将后面其他广告的调价上界全部更新。

  $$ u(s_i^*) = min(u(s_i^*), \quad u(s_k^*)) $$
        
  $$ u(b_i^*) = min(u(b_i^*), \quad \frac{u(s_i^*)}{pctr_i}) $$

如此循环N次，最后把每个广告的出价均调整为其上界$u(b_i^*)$，该算法的整体时间复杂度是$O(X * N * logN)。
