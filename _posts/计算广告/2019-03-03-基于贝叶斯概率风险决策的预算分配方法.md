---
title: 基于贝叶斯概率风险决策的预算分配方法
date: 2019-03-03
categories: 计算广告
tags:
- 计算广告
- Pacing
---

# 背景

关于 pacing 的背景内容，之前一篇文章有介绍，详细参见:[paceing优化技术](https://jadee.github.io/计算广告/2019/03/02/pacing优化技术/)

在之前的系统中很核心的两个系统是影子系统和基于 replay 的模拟系统，前者用以实现撞线计划全天所有候选 auction 的记录，以及当次竞价场景的记录，后者用以模拟完整的线上逻辑求解 pacing 参数，二者是支撑 pacing1.0 功能实现和上线的两个重要的子系统

实际上线后存在两个比较大的问题:

* 影子系统的维护成本

**运维成本**: 影子系统除了撞线计划保留在线状态继续参与竞价之外，要求和线上系 统完全一致，包括策略版本和索引数据更新，增加线上一致性保证的运维成本，且策略或者数据不一致对效果存在较大影响风险

**机器成本**: 一套完整的系统需要搭建完整的引擎各模块。

* 模拟预估系统的效果瓶颈

效果预估是 pacing 参数求解的核心，预估准确率直接影响项目整体效果，pacing 1.0 效果强依赖模拟系统的精度，模拟系统简单理解是对线上投放策略的完整回放，而线上排序系统经常发生变更，而且复杂程度也越来越高，基于模拟的预估系统已经很难持续迭代升级保证精确的模拟真实线上投放，并且这种回放预估的准确率提升优化难度大，不适宜继续基于此系统共优化

因此 pacing 2.0 期望通过概率预估模型实现效果预估，解耦影子系统解决维护成本问题，同时效果预估优化提供可持续迭代空间，提升效果的 upbound

# 问题定义

pacing 问题可以定义为分配问题：

分配问题，客户授权的前提下，使用一定的策略控制预算受限的 campaign 参与或放弃一部分竞价，达到效用最大化的目的。

在做分配之前，我们需要知道一些信息，第一，campaign 预算 ，这很容易知道，第二，候选 auction 集，即未来能够获得展现的 auction 集合。

候选 auction 集可以表达如下：<br>
$S = {a_1, a_2, ..., a_n}$， $a_i$表示候选 auction 集的二元组信息，即 $a_i = (c_i, p_i)$;<br>
$c_i$：表示候选 auction 的期望 cost;<br>
$p_i$：表示候选 auction 的期望 performance。 

$c_i$可以通过 $c_i = cpc_i * pctr_i$ 来计算，performance $p_i$ 这里使用成交额，即 $p_i = pctr_i * pcvr_i * price_i$ ， $pcvr_i$表示搜索引擎给 ad 预估的转化率， $price_i$表示 ad 的笔单价。需要再次说明的是，候选 auction 集的含义是指能够获得展现的 auction 集合，即 $\forall i, i = 1,2,...,n，c_i \gt 0 $ ，因此，它包含了两方面信息：1）大盘的搜索量，2）campaign 的展现概率

**随机 $S$ 的描述**: 我们可以简单直接使用前一天的 campaign 展现日志得到 $S$ ，但存在以下问题：1）对于展现量少的 campaign 会面临鲁棒性问题，这些 case 很容易得到极端的决策，2）$S$ 的 size 仅仅前一天的日志量有关，当天的流量波动无法获知，3）很难得到前一天完整的 $S$ ，因为可能存在 campaign 达到预算限额下线的情况，这样我们不知道后面的候选 auction 是什么

可以看到展现日志得到的确定的 $S$ 存在很多的问题，本质上是信息的缺失而导致的不确定性，因此，我们可以尝试用随机变量来描述 $S$ 。假设 $S$ 的所有可能组成空间 \phi ，任意 $S \in \phi$ 对应其发生的概率，用 $p(S)$ 表示。我们可以用概率模型来预估 $p(S)$，下面会有详细介绍

**在线决策函数**: 算法需要为每个 campaign 在线决定是否参与竞价，这里用决策函数来表示，即 $d = (c, p) \rightarrow {0, 1}$

**目标效用**: 目标效用的设计方式有多种，这里我们考虑以下方式:

$$ u(d, S) = P * min(\frac{B}{C}, 1) $$

其中

$$ P = \sum_{(c,p) \in S} d(c, p) * p $$

$$ C = \sum_{(c,p) \in S} d(c, p) * c $$

很好理解，当 $ B \geq C$ 时预算充裕，$ min(\frac{B}{C}, 1) = 1，u(d, S) = P$，当 $ B \lt C$ 时预算不足，$P$ 是多算了一些效用，实际效用和 $P$ 的比例为 $\frac{B}{C}，u(d, S) = P * \frac{B}{C}$。注意，这里并没有使用强约束方式，首先，强约束方式在描述和求解上更复杂，比如 $P(C \leq B) \geq \epsilon, \epsilon \gt 0$ 为很小的常量，其次，pacing 算法里的超预算不会造成实际的超预算（结算系统的存在），算法的超预算顶多带来效果的折损，折损用效用函数来表达。

我们的问题可以描述为选择最优的决策函数使得期望效用最大化，即

$$ d^{*} = argmax_{d} E_{S ~ p(S)} (u(d, S))$$

## 在线决策函数

这里我们直接给出决策函数的具体形式

$$ d_{\theta}(c, p) = \left\{
\begin{array}{rcl}
1       &      & {if \quad \frac{p}{c} \geq \theta}\\
0       &      & {if \quad \frac{p}{c} \lt \theta}
\end{array} \right. 
\quad \theta \gt 0
$$

决策函数只和 $\theta$ 有关， $\theta$ 表达的含义为性价比阈值，直观理解为选择那些消耗少，performance 多的 auction，这里性价比为 roi。下图为 throttling 和 no throttling 选择 auction 方式的不同

