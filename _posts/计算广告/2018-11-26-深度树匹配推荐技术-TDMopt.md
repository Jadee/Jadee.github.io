---
title: 深度树匹配推荐技术-TDMopt
date: 2018-11-26
categories: 计算广告
tags:
- 计算广告
- Matching
---

# 背景

如下图所示，在大规模任务中，搜索，推荐和广告的系统通常由模型，索引和检索算法三大组件组成。模型计算单个用户-对象的偏好概率，索引将所有商品有序地组织在一起，检索算法根据模型的输出在索引中召回最终的推荐结果。三者共同决定了召回质量且存在内在联系。

<!-- more -->

![avatar](/images/计算广告/ad-28.png)

然而，以推荐为例，现有的推荐体系对模型索引和检索的相互联系往往没有做充分的考量。从联合调优这一视角出发，现有的几代推荐体系的代表算法存在问题分析如下：

* 在经典的Item-CF中，倒排索引根据item之间某种自定义的相似度量建立，检索过程则是根据用户历史行为在倒排索引中查询候选集后排序截断，模型在排序过程中对候选集中的Item根据某种自定义的规则进行打分。在系统中，模型和检索被规则固化，没有学习调优。

* 在向量检索的模式中，系统会分别为用户和商品学习一个向量表达，其内积作为用户对商品的偏好程度的预测。检索等价于用户向量在商品向量集合中的kNN最近邻检索，在大规模问题中，可以采用近似的最近邻索引结构来加速检索。在建立向量检索推荐系统的过程中，模型训练的目标是准确的预测单个用户-对象的偏好概率，而kNN检索索引建立的目标则最小化近似误差，二者的优化方向并不一致。同时，内积形式的偏好预测表达能力有限，无法容纳更加先进的打分模型。

* 在TDM中，我们通过交替迭代优化模型和树结构再加之无参数的逐层beam search检索过程进行了模型、索引和检索联合优化上的实践和创新。然而在TDM中，模型的优化和树结构索引的学习二者的优化目标也不完全一致，这可能导致二者的优化相互牵制而导致最终整体效果次优。特别是对于树结构索引，模型训练样本的构造和检索路径的选择与树结构具有更加紧密的联系。

综上分析，本文在TDM的基础上进一步提出统一目标下联合优化深度模型和树结构索引的大规模推荐算法框架TDMopt(Optimized TDM)。

# 端到端联合学习的深度树匹配推荐技术

TDMopt继承了TDM树结构索引+任意深度用户-商品偏好打分模型的系统框架，通过联合优化和层次化特征建模取得了大幅超越TDM的推荐精度，具有广阔的应用前景，完全具备推广到搜索，广告等相关业务的理由和能力。TDMopt已经在阿里妈妈精准展示广告业务的matching阶段初步落地，在TDM的基础上取得显著效果提升。

## 深度树推荐模型TDM

推荐系统的任务是从候选集(例如，商品库)中选出用户当前偏好的一个子集。当候选集的规模很大时，如何快速有效地从全库中做推荐是一个具有挑战性的问题。之前介绍的深度树匹配推荐技术创造性地采用树结构作为索引结构并进一步地令用户对树上节点的偏好满足下面的近似最大堆性质：

$$ p^{l}(n|u) = \frac{max_{n_c \, \in \, {(n's \, children \, nodes \, in \, level \, j + 1)}} \: p^{j+1}(n_c | u)} {\alpha^{(l)}} $$

其中 $p^{l}(n|u)$ 是用户 $u$ 对节点 $n$ 偏好概率的真值，$\alpha^{(l)}$ 是第 $l$ 层内偏好概率分布的归一化项。这样的建模保证了第 $l$ 层节点中偏好概率最大的 $k$ 个节点一定包含在第 $l - 1$ 层的top-k节点的子节点中。基于这一建模，TDM将推荐问题转换为树结构中自上而下的层次化的检索问题。下图给出了TDM候选子集的生成过程。

![avatar](/images/计算广告/ad-29.png)

首先，候选集中的每个对象(例如，一个商品或者广告)都被分配到树的一个不同叶子节点上，如右图所示。树上的非叶子节点可以看做是它的子节点集合的一个抽象。左图给出了用户对节点的偏好概率的计算过程，用户信息和待打分的节点首先被向量化为深度打分网络(例如，全连接网络，attention网络等等)的输入，网络的输出作为用户对该节点的偏好概率。在检索top-k的候选子集即top-k叶子节点的过程中，我们采用自顶向下的逐层beam search方法。在第
l
层中，我们只对第
l
−
1
层被选中的
k
个节点的子节点进行打分和排序来选择第
l
层的
k
个候选。图(b)给出了检索过程的示意。

通过采用树结构作为索引，对一个用户的偏好子集进行top1检索的时间复杂度为
O
(
log
(
N
)
)
，其中
N
为全部候选集的大小。这一复杂度也与用户偏好打分模型的结构无关。同时，近似最大堆的假设将模型学习的目标转化为用户-节点偏好分布的学习，这使得TDM能够打破最近邻检索模式带来的内积形式的用户偏好打分的限制，赋能任意复杂打分模型，从而极大的提升了推荐的准确率。



