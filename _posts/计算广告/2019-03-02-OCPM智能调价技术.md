---
title: OCPM智能调价技术
date: 2019-03-01
categories: 计算广告
tags:
- 计算广告
- 机制设计
---

# 问题背景

## RTB广告简介

RTB广告的核心思想之一便是售卖人而不是广告位。简单来说，就是把你的每次页面浏览，通过拍卖的形势卖给广告主，谁出的价高就把你的这次浏览卖给谁，然后显示相应的广告。通过竞价拍卖，每次展示机会都可以尽可能的卖到广告主最高的意愿价格，这样流量的分配效率得到极大提升，平台也会因此获利。

<!-- more -->

当前比较主流的广告计费方式有CPM和CPC计费（CPC为通过互联网广告采购流量按照点击付费，每一次点击费用；CPM为通过互联网广告采购流量按照展现付费，每千次展现的费用）。本文主要探讨CPM计费下的更优的出价机制，暂不讨论CPC计费模式。

## CPM报价缺陷

在实际的投放中，广告主没有能力做到对每个流量都做到实时的手动出价，而是出价在定向人群粒度。这种出价方式的问题有：

1. 广告主在圈定人群上按照同一报价参竞，价值高于出价的pv可能因出价不够而错过，价值低于出价的pv可能会因竞得而产生亏损。<br>
2. 广告主人工按照pv价值进行圈定不同的人群，进行出价，粒度越细，广告主尝试成本越高，且不可能做到pv粒度的出价。

简单总结就是：RTB广告下，使用传统的CPM出价，广告主会有出价粒度粗，准确出价难，效果欠佳的问题；平台流量分配效率低下，收入受损。

随着RTP（实时预估）技术的成熟，平台已经可以做到实时预估单次pv对参竞广告主的价值。我们认为平台可以依赖RTP技术，由平台代广告主进行pv粒度的实时调价，即OCPM，也称智能CPM。

# GSP

当前主流DSP（需求方平台，也称广告主平台）采用的竞价机制——GSP(第二价格密封拍卖)。第二价格密封拍卖简单地说就是：竞拍者同样以密封的形式独立出价，出价最高者竞得，但结算价格为所有出价中的第二高价。

定义变量:

* Bp: bid price，为广告主的出价;<br>
* Value: 广告主对流量的估价，即该流量对于广告主的价值

这里省略掉推导过程，直接给出GSP下重要的结论：在预算无限（相对流量是充足的）下，广告主的最优报价策略均是：$Bp = Value$，又称“诚实报价(truly bidding)”。

# OCPM的实现思路

OCPM正是希望帮助广告主在CPM出价下做到truly bidding。其实现思路可以抽象为：将广告主的CPM出价转换为CPC或CPA出价，然后按照pv的价值进行truly bidding。

为了度量一个pv对广告主的价值，我们可以用展示价值、点击价值、或者转化价值等。在实际落地中，我们先选择了pctr（预估ctr）来度量单个pv对广告主的价值。确定选择使用pctr来衡量pv价值后，便需要将广告主的CPM出价转换为CPC出价，即点击出价。我们定义广告主作出CPM出价bid_price所对标的ctr为基准ctr，简称bctr。bid_price/bctr即可看做广告主的点击出价。

接下来便是解决以下两个问题：

1. bctr的计算逻辑<br>
2. 调价函数的设计

## bctr计算逻辑

CPM出价方式下，其出价是根据竞得流量的投放效果进行调整，以达到在竞得流量上的truly bidding。因此bctr可以看做广告主在CPM出价下竞得流量的平均价值。

由于OCPM会改变广告主的竞得流量分布。因此，这里我们选择使用模拟未经过OCPM调价的环境下广告主的竞得流量的pctr作为bctr。

$$  bctr = \frac{\sum_{i=1}^n pctr_i}{n}, \quad 1...n为模拟原始竞得pv$$

## 调价函数设计

设计OCPM的调价函数时，综合考虑了多重因素。

### 线性调价函数

首先保证满足truly biding的基本设计，采用线性函数。

$$ bid\_price = \frac{org\_price}{bctr} * pctr $$

这样原始的调价幅度即为： $scale = \frac{pctr - bctr}{bctr}$

### 线性调价函数 + 折价系数

在原始调价幅度的基础上，加入了对幅度的折扣系数，即折价系数。

$$f(scale)=
\begin{cases}
scale * discount\_upper & \text{if scale >= 0}\\
scale * discount\_lower & \text{if scale < 0}
\end{cases}$$

折价系数的设计主要考虑了以下几点：<br> 
1. 通过折价系数对ctr预估的误差存在一定的容错鲁棒性。<br>
2. 通过折价系数让广告主享受到更大的cpc降低幅度。让广告主享受到更大的cpc降低幅度，对OCPM在广告主中的快速普及帮助很大。 <br>
3. 更加深层的解释：折价系数表征对PV价值中考虑点击价值的权重。

### 线性调价函数 + 折价系数 + 调价幅度区间 

在线性调价函数和折价系数的基础上，再加入了调价幅度的区间限制。


$$ bid\_price =
\begin{cases}
org\_price * (1 + Min[f, price\_scale\_max]) & \text{if f >= 0}\\
org\_price * (1 + Max[f, price\_scale\_min]) & \text{if f < 0}
\end{cases}$$

该限制的主要目的是为了保留CPM出价的部分特性：<br> 
1. 不完全放弃对展示成本的控制，避免客户承担不可预估的成本风险。 <br>
2. 不完全放开调价区间，保留CPM出价对流量的控制能力。 <br>
3. 通过调价幅度的限制并不完全将人群价值的划分交给RTP，可以看做对应用精准人群定向和RTP区分人群价值的权衡。

## OCPM优化

### 模型择优

CTR 预估的精准度影响着广告的单位收入和流量的深度精细化利用。对于OCPM项目而言，预估模型的精准度越高，即pv价值预估的越准确，越能做到逼近价值报价。 因此，我们修改了线上引擎模块和离线流程，支持同时产出基于不同rtp-model的bctr，进而可以支持OCPM做rtp-model的A/B测试，使其可以快速尝试rtp迭代的新模型，享受rtp模型迭代优化的红利。

### bctr精准度优化

从OCPM设计方案可以看到OCPM非常依赖rtp技术和bctr的计算。bctr的精准度是OCPM能做到逼近truly bidding的又一核心因素。 在早期的bctr产出流程的设计中，我们使用前一天的参竞日志（记录了前一天rtp实时给出的pctr），计算好bctr后，传给OCPM调价模块，应用新计算好的bctr进行调价。在OCPM上线后的一段时间，存在较严重的效果不稳定情况，会时不时地出现普遍上调报价或下调报价，节假日尤甚。这主要源自两方面：

1. rtp模型一致性问题<br>
2. PV日志一致性问题 

#### rtp模型一致性问题 

用来计算bctr的pctr（来自T-1的rtp实时返回），与T的rtp使用的model普遍存在不一致的问题（因模型是天级更新，相邻天级的模型预估可能存在显著差异）。 

解决方案：增加ctr离线预估模块，使用T新产出的模型对T-1的日志重新预估ctr，使得得到的bctr和T的线上实时预估来自同一模型。 

#### PV日志一致性问题 用来计算bctr的T-1日志，和实际调价作用的T流量存在流量不一致的差异。由于天级可竞PV不管是数量还是质量分布都存在一定差异。 

解决方案：增加bctr小时级校准模块，应用T已产出的日志对计算的bctr进行校准，校准模块小时周期运行，使其更接近于使用T日志产出的bctr，极大降低了日志不一致造成的bctr误差。 

bctr的精准度优化方案上线后，调价分布非常稳定，效果也极其稳定，多个月未再发生过普遍下调或上调的情况，效果的稳定性得到极大的提升。

### 引入转化因素 

自然地，我们将OCPM引入了pcvr指标衡量流量价值，以优化转化为目标提升平台流量的分配效率，同时也提高了广告主的转化效果。 实现思路一脉相承，定义pv的价值的衡量指标为$pvalue$。其转化价值公式为：

$$ pvalue = pctr * pcvr^{\alpha}, \quad 0 \leq alpha \leq 1 $$

设置$\alpha$参数作为OCPM引入转化因素的权重。与bctr相应，我们定义广告主作出CPM出价bp所对标的value为基准value，bvalue的计算逻辑也与bctr一致。

至于调价函数的设计，bvalue的计算和校准方案也与只依赖pctr的设计思路一致，这里便不再赘述。

# OCPM总结

**从效果和大盘收益角度看**，OCPM调价技术实现了广告主和平台的共赢，提升了平台的流量分配效率，提升了广告主的投放效果。从中长期上，OCPM提升了广告主的留存，刺激了广告主增加预算，显著提升了大盘的收入。

**从机制角度看**，引入pctr的OCPM可以看做一种半CPC模式，和CPC的区隔是：

1. 结算方式的不同，OCPM是客户承担预估不准的风险，CPC是平台承担预估不准的风险。在预估不可能完全精准的情况下，OCPM对平台收入可能造成的损失更小。<br>
2. 出价基准的不同，OCPM是基于cpm报价上下调整出价，而CPC是基于cpc出价*pctr报价，当rtp预估高估或低估时，会使客户调整cpc出价却无法满足对调整真实报价的期望。OCPM的出价方式可以更直接控制在流量上的报价。即cpc下客户面临着rtp预估不准带来的报价不确定，进而导致对流量的可控性减弱。而OCPM下客户在无论rtp是否高低估下对流量的可控性依然较强，但承担着投放的cpc指标的可控性较弱。

OCPM给客户提供了一种CPM出价下的智能调价技术，对平台的机制建设有重大的意义。


