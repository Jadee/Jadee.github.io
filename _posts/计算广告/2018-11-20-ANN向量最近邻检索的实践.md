---
title: ANN向量最近邻检索的实践
date: 2018-11-20
categories: 计算广告
tags:
- 计算广告
- 广告触发
---

# 背景

向量化召回相比以前的召回方式，可以利用更为全面的信息，提高全流量的匹配精度，扩大长尾流量的召回深度，而向量最近邻检索是向量化召回的关键能力，对召回效果有非常重要的影响。

<!-- more -->

向量化召回模型的简要示意图如下：

![avatar](/images/trigger/trigger-36.png)

将用户请求信号通过左侧深度网络表达为一个向量 $q$，广告信息通过右侧深度网络表达为一个向量 $a$，然后用两者的向量距离（欧式/cos/內积）来表征广告点击率，$q$ 与 $a$ 的距离越近，则预估点击率越高。

在向量化召回系统中，向量最近邻检索是重要一环，其作用是：以尽可能高效的方式在广告向量库中检索出与请求向量 $q$ 距离最近的topK个广告。这些广告作为最具潜力的广告将被送入排序模块进行综合打分。

![avatar](/images/trigger/trigger-37.png)

如何在大规模向量库中快速地找到距离最近的topK向量集合？这个问题在学术界上被称为“最近邻检索”（Approximate Nearest Neighbor）。

基础的量化方法只能支持向量欧式距离，这大大限制了向量化召回的模型设计。为了支持更多的距离度量（cos/內积），通过在索引构建流程中集成了向量变换算法，从而解决了这一难题。此工作将在第三节“支持多种距离度量”中进行介绍。

另外，对于搜索广告的业务场景，有两大特色：一是系统中有数百万的广告主参与，据统计，淘宝直通车广告主每天增删广告12.1万次，修改广告31.5万次。广告主对广告的增删改操作需要在向量索引库中实时生效，这就要求我们的向量化引擎和最近邻检索算法具备支持实时更新的能力。二是广告召回阶段需要考虑RPM等业务指标，因此对于业务指标表现较好的广告，我们应该在最近似检索时给予更准确的距离度量。为了满足这两大业务需求，需要对标准的向量近邻检索进行优化升级，这将在第四节“支持在线加权量化”中进行介绍。

# 相关研究

随着深度学习的兴起，向量的最近邻检索在近些年获得了大量关注。目前，主流的ANN算法有四类：

## 基于树结构的方法

首先使用树结构（KD-tree/KMeans-tree等）对向量空间进行逐层切分，然后将query向量 $q$ 从根节点开始走一遍树结构，直到叶子节点。与 $q$ 同叶子节点的候选向量作为近邻向量被返回。如果单个叶子节点中的候选向量数量不够，则树方法还会进行回溯，从而召回更多邻近叶子的向量。

树方法的优势是原理简单，实现容易。缺点是在向量维度较大时（>10维）就将退化为线性搜索，效率与暴力差不多。

## 基于Hash的方法

Hash类的方法首先使用哈希函数将向量投射到一个向量桶中，理想的哈希函数能够将相近的向量投射到同一个向量桶中。近邻搜索时，仅在 $q$ 所在的向量桶及其邻近桶中进行查找，以此缩小了搜索范围，提高了搜索效率。

Hash类的方法本质上依然是对空间的切分，后面出现的图方法和量化方法都宣称获得了比Hash更好的效果。



